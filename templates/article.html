{% extends "base.html" %}

{% block title %}Article: {{ article.filename }}{% endblock %}

{% block head_extra %}
<style>
    /* Styles from your original article.html <style> block */
    .audiobook-controls {
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .audiobook-controls label, .audiobook-controls button, .audiobook-controls a {
        margin-right: 10px;
        vertical-align: middle;
    }
    .download-mp3-button {
        display: inline-block;
        padding: 6px 12px;
        margin-bottom: 0;
        font-size: 14px;
        font-weight: 400;
        line-height: 1.42857143;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        cursor: pointer;
        background-image: none;
        border: 1px solid transparent;
        border-radius: 4px;
        color: #fff;
        background-color: #5cb85c;
        border-color: #4cae4c;
        text-decoration: none;
    }
    .download-mp3-button:hover {
        background-color: #449d44;
        border-color: #398439;
    }
    .playing-sentence {
        background-color: #cce5ff; /* Light blue for actively playing */
    }
    .highlighted-sentence {
        background-color: #ffe0b2; /* Orange/yellow for selected/focused */
    }
    audio#audioPlayer {
        display: none; 
        width: 100%;
        margin-top: 10px;
    }

    /* Contextual Menu Styles - Enhanced */
    #contextual-menu {
        display: none;
        position: absolute;
        background-color: #ffffff;
        border: 1px solid #d1d1d1;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1001;
        padding: 6px 0;
        min-width: 50px; 
        transition: opacity 0.1s ease-in-out, transform 0.1s ease-in-out; /* Added transform for subtle pop */
        transform-origin: top left; /* Default, will be adjusted by JS */
    }
    .contextual-menu-item {
        display: flex; 
        align-items: center; 
        padding: 10px 15px; 
        cursor: pointer;
        font-size: 1.3em; 
        color: #333;
        transition: background-color 0.15s ease-in-out;
        white-space: nowrap; 
    }
    .contextual-menu-item:hover {
        background-color: #f0f2f5; 
        color: #007bff; 
    }
    .contextual-menu-item .menu-icon { 
        margin-right: 0px; 
        line-height: 1; 
    }
     .contextual-menu-item .menu-text {
        margin-left: 8px; 
        font-size: 0.7em; 
        vertical-align: middle;
    }
    
    #translation-popup {
        display: none;
        position: absolute;
        border: 1px solid #aaa;
        background-color: #f9f9f9;
        padding: 10px 15px;
        border-radius: 4px;
        box-shadow: 0px 2px 8px rgba(0,0,0,0.15);
        z-index: 1000;
        max-width: 350px;
        font-size: 0.95em;
        color: #333;
        line-height: 1.5;
    }

    /* Go Back Button Style */
    #goBackButton {
        position: fixed;
        bottom: 20px; 
        right: 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 1.5em; 
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        display: none; 
        justify-content: center;
        align-items: center;
        z-index: 1002; 
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        opacity: 0;
        transform: scale(0.8);
    }
    #goBackButton.visible {
        display: flex; 
        opacity: 1;
        transform: scale(1);
    }
    #goBackButton:hover {
        background-color: #0056b3;
    }
    
    /* Go To Top Button Style */
    #goToTopButton {
        position: fixed;
        bottom: 80px; /* Position above the goBackButton */
        right: 20px;
        background-color: #17a2b8; /* Different color for distinction */
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 1.5em;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1002;
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        opacity: 0;
        transform: scale(0.8);
    }
    #goToTopButton.visible {
        display: flex;
        opacity: 1;
        transform: scale(1);
    }
    #goToTopButton:hover {
        background-color: #117a8b;
    }

    /* Restore Location Button Style */
    #restoreLocationButton {
        display: none; /* Hidden by default, shown by JS if location exists */
        margin-left: 15px;
        padding: 5px 10px;
        font-size: 0.9em;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    #restoreLocationButton:hover {
        background-color: #5a6268;
    }
    
    /* Styles for audio parts controls */
    #audiobook-parts-controls, #parts-audio-download { /* Combined download controls style */
        margin-top: 15px;
        padding: 10px;
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }
    #audio-part-selector-playback label, #audio-part-selector-download label { /* Combined selector label style */
        margin-right: 10px;
        font-weight: normal;
    }
    #audio-part-selector-playback input[type="radio"], #audio-part-selector-download input[type="radio"] { /* Combined radio style */
        margin-right: 5px;
        vertical-align: middle;
    }
    #loadSelectedAudioPartButton, #downloadSelectedAudioPartButton, #switchToPartsViewButton, #switchToFullViewButton,
    #loadLocalAudioPartButton { 
        padding: 6px 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left:10px;
        margin-top: 5px; 
        margin-bottom: 5px;
    }
    #loadSelectedAudioPartButton:hover, #downloadSelectedAudioPartButton:hover, #switchToPartsViewButton:hover, #switchToFullViewButton:hover,
    #loadLocalAudioPartButton:hover { 
        background-color: #0056b3;
    }
    #audio-part-selector-playback, #audio-part-selector-download {
        margin-bottom: 10px; /* Space before the button */
    }
    #gamepad-status-emoji {
        position: fixed;
        bottom: 10px; /* Adjust as needed */
        left: 10px;   /* Adjust as needed */
        font-size: 1.8em; /* Adjust emoji size */
        padding: 5px;
        background-color: rgba(255, 255, 255, 0.0); /* Transparent background initially */
        border-radius: 50%;
        width: 30px;  /* Approximate, adjust with font-size and padding for centering */
        height: 30px; /* Approximate */
        line-height: 30px; /* For vertical centering of emoji */
        text-align: center; /* For horizontal centering of emoji */
        cursor: default;
        z-index: 1005;
        transition: color 0.3s ease-in-out, background-color 0.3s ease-in-out; /* Smooth color transition */
        color: #AAAAAA; /* Default: Disconnected color */
    }

    #gamepad-status-emoji.connected {
        color: #4CAF50; /* Green for connected */
        /* background-color: rgba(76, 175, 80, 0.1); Optional subtle green background */
    }

    #gamepad-status-emoji.error {
        color: #F44336; /* Red for error */
        /* background-color: rgba(244, 67, 54, 0.1); Optional subtle red background */
    }
    /* End NEW styles for gamepad EMOJI icon */

    .waveform-canvas {
        display: block; /* Make it a block element to take full width of its parent paragraph */
        width: 100%;    /* Ensure it respects the parent paragraph's width */
        height: 75px;   /* Consistent with JS height setting */
        margin-top: 10px; /* Space above the canvas, separating from sentence */
        margin-bottom: 10px; /* Space below the canvas */
        border: 1px solid #cccccc; /* A light border */
        background-color: #f8f9fa; /* A light background, distinct from sentence highlight */
        box-sizing: border-box; /* Include padding and border in the element's total width and height */
    }
</style>
{% endblock %}


{% block content %}
    {% if book %}
    <p><a href="{{ url_for('book_detail_page', book_id=book.id) }}">¬´ Back to Book: {{ book.title }}</a></p>
    {% else %}
    <p><a href="{{ url_for('list_books_page') }}">¬´ Back to Books List (Book info missing for this article)</a></p>
    {% endif %}

    <h1>{{ article.filename }}
        <button id="restoreLocationButton" title="Restore Last Reading Position">üîñ</button>
    </h1>
    
    <button id="goToTopButton" title="Go to Top">‚¨ÜÔ∏è</button> 
    <button id="goBackButton" title="Go Back to Highlighted Sentence">‚¨áÔ∏è</button> 
    
    {# --- JSON Data Island for JavaScript --- #}
    <script id="article-data-json" type="application/json">
        {{
            {
                "articleId": article.id,
                "hasTimestamps": has_timestamps,
                "convertedMp3Path": article.converted_mp3_path,
                "mp3PartsFolderPath": article.mp3_parts_folder_path,
                "numAudioParts": article.num_audio_parts if article.num_audio_parts is not none else 0,
                "initialReadingLocation": reading_location,
                "articleAudioPartChecksums": article_audio_part_checksums
            } | tojson | safe
        }}
    </script>
    {# --- END NEW --- #}
    <div id="gamepad-status-emoji" title="No Gamepad Connected">üéÆ</div>


    {% if article.mp3_parts_folder_path and article.num_audio_parts and article.num_audio_parts > 0 %}
        <button id="switchToPartsViewButton">Switch to Audio Parts View</button>
        <button id="switchToFullViewButton" style="display:none;">Switch to Full Audio View</button>
    {% endif %}

    {% if has_timestamps %}
        <div id="full-audio-view-controls">
            <div class="audiobook-controls">
                <button id="toggleAudiobookMode">Enable Audiobook Mode (Full Audio)</button>
                <input type="file" id="localAudioFile" accept=".mp3,.wav,.m4a" style="display: none;">
                <span id="audioFileName" style="margin-left: 10px;">No audio file selected.</span>
                <audio id="audioPlayer" controls></audio> 
                <p id="audiobookHint" style="font-size:0.9em; color: #555; margin-top: 5px; display:none;">
                    Select your local FULL audio file. Click on an English sentence to play its audio.
                </p>
            </div>
        </div>

        <div id="parts-audio-view-controls" style="display:none;">
             <div id="audiobook-parts-controls">
                <p><strong>Audiobook Mode (Audio Parts)</strong></p>
                <p>Select Audio Part to load for playback:</p>
                <div id="audio-part-selector-playback">
                    <!-- Radio buttons will be populated by JS -->
                </div>
                <button id="loadSelectedAudioPartButton">Load Part (Server)</button>
                <button id="loadLocalAudioPartButton" style="margin-left: 5px;">Load Part (Local File)</button>
                <input type="file" id="localAudioPartFileInput" accept=".mp3" style="display: none;">
                <span id="loadedAudioPartName" style="margin-left: 10px;">No part loaded.</span>
                <p id="audiobookPartsHint" style="font-size:0.9em; color: #555; margin-top: 5px;">Click a sentence to play. If it's in a different part, you'll be prompted to load it.</p>
            </div>
        </div>
    {% else %} {# no timestamps at all #}
    <p><em>Audio timestamps not available for this article. 
        <a href="{{ url_for('align_audio_for_article', article_id=article.id) }}">Align Audio?</a>
    </em></p>
    {% endif %}

    {% if article.converted_mp3_path %}
    <div style="margin-bottom: 15px;">
        <div id="full-audio-download">
            <a href="{{ url_for('download_mp3_for_article', article_id=article.id) }}" class="download-mp3-button">Download Full Audio (MP3)</a>
        </div>
        {% if article.mp3_parts_folder_path and article.num_audio_parts and article.num_audio_parts > 0 %}
        <div id="parts-audio-download" style="display:none;">
            <p><strong>Download Audio Part:</strong></p>
            <div id="audio-part-selector-download">
                <!-- Radio buttons will be populated by JS -->
            </div>
            <button id="downloadSelectedAudioPartButton">Download Selected Part</button>
        </div>
        {% endif %}
    </div>
    {% endif %}


    <div class="bilingual-content" id="article-content-wrapper">
        {% if structured_article %}
            {% for paragraph_sentences in structured_article %}
                <div class="paragraph">
                    <p>
                        {%- for sentence_pair in paragraph_sentences -%}
                            <span class="english-sentence" 
                                  data-translation="{{ sentence_pair.chinese }}"
                                  data-paragraph-index="{{ sentence_pair.paragraph_index }}"
                                  data-sentence-index="{{ sentence_pair.sentence_index_in_paragraph }}"
                                  {% if sentence_pair.start_time_ms is not none %} data-start-time-ms="{{ sentence_pair.start_time_ms }}"{% endif %}
                                  {% if sentence_pair.end_time_ms is not none %} data-end-time-ms="{{ sentence_pair.end_time_ms }}"{% endif %}
                                  {% if article.num_audio_parts and article.num_audio_parts > 0 %}
                                    {% if sentence_pair.audio_part_index is not none %} data-audio-part-index="{{ sentence_pair.audio_part_index }}"{% endif %}
                                    {% if sentence_pair.start_time_in_part_ms is not none %} data-start-time-in-part-ms="{{ sentence_pair.start_time_in_part_ms }}"{% endif %}
                                    {% if sentence_pair.end_time_in_part_ms is not none %} data-end-time-in-part-ms="{{ sentence_pair.end_time_in_part_ms }}"{% endif %}
                                  {% endif %}>
                                {{- sentence_pair.english -}}
                            </span>{{- " " -}}
                        {%- endfor -%}
                    </p>
                </div>
            {% endfor %}
        {% else %}
            <p>No content found for this article, or the article is empty.</p>
        {% endif %}
    </div>

    <div id="translation-popup"></div>

    <div id="contextual-menu">
        <!-- Menu items will be populated by JavaScript -->
    </div>
{% endblock %}


{% block scripts %}
<script src="{{ url_for('static', filename='js/article_view.js') }}" defer></script>
{% endblock %}