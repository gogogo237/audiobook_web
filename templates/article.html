<!-- bilingual_app/templates/article.html -->
{% extends "base.html" %}

{% block title %}Article: {{ article.filename }}{% endblock %}

{% block head_extra %}
<style>
    /* ... (previous styles for audiobook-controls, download-mp3-button, playing-sentence, highlighted-sentence, audio#audioPlayer remain the same) ... */
    .audiobook-controls {
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .audiobook-controls label, .audiobook-controls button, .audiobook-controls a {
        margin-right: 10px;
        vertical-align: middle;
    }
    .download-mp3-button {
        display: inline-block;
        padding: 6px 12px;
        margin-bottom: 0;
        font-size: 14px;
        font-weight: 400;
        line-height: 1.42857143;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        cursor: pointer;
        background-image: none;
        border: 1px solid transparent;
        border-radius: 4px;
        color: #fff;
        background-color: #5cb85c;
        border-color: #4cae4c;
        text-decoration: none;
    }
    .download-mp3-button:hover {
        background-color: #449d44;
        border-color: #398439;
    }
    .playing-sentence {
        background-color: #cce5ff;
    }
    .highlighted-sentence {
        background-color: #ffe0b2;
    }
    audio#audioPlayer {
        display: none; 
        width: 100%;
        margin-top: 10px;
    }


    /* Contextual Menu Styles - Enhanced */
    #contextual-menu {
        display: none;
        position: absolute;
        background-color: #ffffff;
        border: 1px solid #d1d1d1;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1001;
        padding: 6px 0;
        min-width: 50px; 
        transition: opacity 0.1s ease-in-out, transform 0.1s ease-in-out; /* Added transform for subtle pop */
        transform-origin: top left; /* Default, will be adjusted by JS */
    }
    .contextual-menu-item {
        display: flex; 
        align-items: center; 
        padding: 10px 15px; 
        cursor: pointer;
        font-size: 1.3em; 
        color: #333;
        transition: background-color 0.15s ease-in-out;
        white-space: nowrap; 
    }
    .contextual-menu-item:hover {
        background-color: #f0f2f5; 
        color: #007bff; 
    }
    .contextual-menu-item .menu-icon { 
        margin-right: 0px; 
        line-height: 1; 
    }
    
    #translation-popup {
        display: none;
        position: absolute;
        border: 1px solid #aaa;
        background-color: #f9f9f9;
        padding: 10px 15px;
        border-radius: 4px;
        box-shadow: 0px 2px 8px rgba(0,0,0,0.15);
        z-index: 1000;
        max-width: 350px;
        font-size: 0.95em;
        color: #333;
        line-height: 1.5;
    }

    /* Go Back Button Style */
    #goBackButton {
        position: fixed;
        bottom: 20px; /* Position above where footer actions might have been */
        right: 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 1.5em; /* Icon size */
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        display: none; /* Initially hidden */
        justify-content: center;
        align-items: center;
        z-index: 1002; /* Above contextual menu */
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        opacity: 0;
        transform: scale(0.8);
    }
    #goBackButton.visible {
        display: flex; /* Use flex to center icon */
        opacity: 1;
        transform: scale(1);
    }
    #goBackButton:hover {
        background-color: #0056b3;
    }

</style>
{% endblock %}


{% block content %}
    {% if book %}
    <p><a href="{{ url_for('book_detail_page', book_id=book.id) }}">¬´ Back to Book: {{ book.title }}</a></p>
    {% else %}
    <p><a href="{{ url_for('list_books_page') }}">¬´ Back to Books List (Book info missing for this article)</a></p>
    {% endif %}

    <h1>{{ article.filename }}</h1>

    <button id="goBackButton" title="Go Back to Highlighted Sentence">‚¨áÔ∏è</button> 
    
    <div id="python-debug-info" style="display:none;">
        Python `has_timestamps`: {{ has_timestamps|tojson }}
        Python `article.converted_mp3_path`: {{ article.converted_mp3_path|tojson }}
    </div>

    <!-- ... (rest of the content: audiobook-controls, download button, article-content-wrapper, translation-popup, contextual-menu) ... -->
    {% if has_timestamps %}
    <div class="audiobook-controls">
        <button id="toggleAudiobookMode">Enable Audiobook Mode</button>
        <input type="file" id="localAudioFile" accept=".mp3,.wav,.m4a" style="display: none;">
        <span id="audioFileName" style="margin-left: 10px;">No audio file selected.</span>
        <audio id="audioPlayer" controls></audio> 
        <p id="audiobookHint" style="font-size:0.9em; color: #555; margin-top: 5px; display:none;">
            Select your local audio file. Click on an English sentence to play its audio. (Using Web Audio API for playback)
        </p>
    </div>
    {% else %}
    <p><em>Audio timestamps not available for this article. 
        <a href="{{ url_for('align_audio_for_article', article_id=article.id) }}">Align Audio?</a>
    </em></p>
    {% endif %}

    {% if article.converted_mp3_path %}
    <div style="margin-bottom: 15px;">
        <a href="{{ url_for('download_mp3_for_article', article_id=article.id) }}" class="download-mp3-button">Download Converted Audio (MP3)</a>
    </div>
    {% endif %}


    <div class="bilingual-content" id="article-content-wrapper">
        {% if structured_article %}
            {% for paragraph_sentences in structured_article %}
                <div class="paragraph">
                    <p>
                        {%- for sentence_pair in paragraph_sentences -%}
                            <span class="english-sentence" 
                                  data-translation="{{ sentence_pair.chinese }}"
                                  {% if sentence_pair.start_time_ms is not none %} data-start-time-ms="{{ sentence_pair.start_time_ms }}"{% endif %}
                                  {% if sentence_pair.end_time_ms is not none %} data-end-time-ms="{{ sentence_pair.end_time_ms }}"{% endif %}>
                                {{- sentence_pair.english -}}
                            </span>{{- " " -}}
                        {%- endfor -%}
                    </p>
                </div>
            {% endfor %}
        {% else %}
            <p>No content found for this article, or the article is empty.</p>
        {% endif %}
    </div>

    <div id="translation-popup"></div>

    <div id="contextual-menu">
        <!-- Menu items will be populated by JavaScript or predefined here -->
    </div>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ... (previous JS variable initializations: pythonHasTimestamps, pythonConvertedMp3Path, etc.) ...
    let pythonHasTimestamps = false;
    let pythonConvertedMp3Path = null;
    try {
        const debugInfoElement = document.getElementById('python-debug-info');
        if (debugInfoElement) {
            const textContent = debugInfoElement.textContent;
            const parts = textContent.split('Python ');
            parts.forEach(part => {
                if (part.startsWith('`has_timestamps`:')) {
                    const jsonPart = part.substring(part.indexOf(':') + 1).trim().split(' Python')[0].trim();
                    pythonHasTimestamps = JSON.parse(jsonPart);
                } else if (part.startsWith('`article.converted_mp3_path`:')) {
                    const jsonPart = part.substring(part.indexOf(':') + 1).trim().split(' Python')[0].trim();
                    pythonConvertedMp3Path = JSON.parse(jsonPart);
                }
            });
        }
    } catch (e) {
        console.error("JS: Error parsing python-debug-info:", e);
    }
    
    const articleContentWrapper = document.getElementById('article-content-wrapper');
    const popup = document.getElementById('translation-popup');
    let highlightedSentence = null; // This will store the DOM element
    let lastHighlightedSentenceElement = null; // To remember for the "Go Back" button
    let currentPopupTargetSentence = null;
    const contextualMenu = document.getElementById('contextual-menu');
    const goBackButton = document.getElementById('goBackButton');

    let audioContext = null;
    let audioBuffer = null;
    let currentSourceNode = null;
    let isAudiobookMode = false;
    let currentPlayingSentence = null;
    let maxSentenceEndTime = 0; 

    const toggleAudiobookModeButton = document.getElementById('toggleAudiobookMode');
    const localAudioFileInput = document.getElementById('localAudioFile');
    const audioFileNameSpan = document.getElementById('audioFileName');
    const audiobookHint = document.getElementById('audiobookHint');

    // --- Go Back Button Logic ---
    function updateGoBackButtonVisibility() {
        if (lastHighlightedSentenceElement && (window.scrollY > 100 || document.documentElement.scrollTop > 100)) { // Show if scrolled and sentence was highlighted
            const sentenceRect = lastHighlightedSentenceElement.getBoundingClientRect();
            // Show if sentence is not fully visible or scrolled significantly past it
            if (sentenceRect.bottom < 0 || sentenceRect.top > window.innerHeight || Math.abs(window.scrollY - lastHighlightedSentenceElement.offsetTop) > window.innerHeight / 2) {
                 goBackButton.classList.add('visible');
            } else {
                 goBackButton.classList.remove('visible');
            }
        } else {
            goBackButton.classList.remove('visible');
        }
    }

    if (goBackButton) {
        goBackButton.addEventListener('click', function() {
            if (lastHighlightedSentenceElement) {
                lastHighlightedSentenceElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Highlight it again briefly or ensure it's styled as active
                if (highlightedSentence) highlightedSentence.classList.remove('highlighted-sentence');
                lastHighlightedSentenceElement.classList.add('highlighted-sentence');
                highlightedSentence = lastHighlightedSentenceElement;

                // Optionally hide the go back button after use or let scroll listener handle it
                setTimeout(() => updateGoBackButtonVisibility(), 500); // Re-check after scroll
            }
        });
        window.addEventListener('scroll', updateGoBackButtonVisibility);
        window.addEventListener('resize', updateGoBackButtonVisibility);
    }

    // --- Contextual Menu & Popups ---
    function displayPopup(targetElement, content) { 
        popup.innerHTML = content;
        const rect = targetElement.getBoundingClientRect();
        popup.style.visibility = 'hidden';
        popup.style.display = 'block';
        const popupWidth = popup.offsetWidth;
        const popupHeight = popup.offsetHeight;
        let popupTop = rect.bottom + window.scrollY + 8;
        let popupLeft = rect.left + window.scrollX + (rect.width / 2) - (popupWidth / 2);

        const minLeft = 10 + window.scrollX;
        const viewportWidth = window.innerWidth;
        let maxLeft = window.scrollX + viewportWidth - popupWidth - 10;
        if (maxLeft < minLeft) maxLeft = minLeft;
        popupLeft = Math.max(minLeft, Math.min(popupLeft, maxLeft));
        if (popupTop < window.scrollY + 10) popupTop = window.scrollY + 10;
        const viewportHeight = window.innerHeight;
        if (popupTop + popupHeight > window.scrollY + viewportHeight - 10) {
            let alternativeTop = rect.top - popupHeight - 8 + window.scrollY;
            if (alternativeTop > window.scrollY + 10) {
                popupTop = alternativeTop;
            } else { 
                popupTop = window.scrollY + viewportHeight - popupHeight - 10;
            }
        }
        popup.style.top = popupTop + 'px';
        popup.style.left = popupLeft + 'px';
        popup.style.visibility = 'visible';
    }

    function hideContextualMenu() {
        if (contextualMenu) {
            contextualMenu.style.opacity = '0'; 
            contextualMenu.style.transform = 'scale(0.95)'; // Shrink slightly on hide
            setTimeout(() => { 
                contextualMenu.style.display = 'none';
            }, 100); 
        }
    }

    function hideTranslationPopup() {
        if (popup) {
            popup.style.display = 'none';
            currentPopupTargetSentence = null;
        }
    }

    function populateAndShowContextualMenu(sentenceElement, clickX) {
        if (!contextualMenu || !sentenceElement) return;

        let menuHTML = `<div class="contextual-menu-item" data-action="show-translation" title="Show Chinese Translation"><span class="menu-icon">üí¨</span></div>`;
        menuHTML += `<div class="contextual-menu-item" data-action="go-to-top" title="Go to Top"><span class="menu-icon">‚¨ÜÔ∏è</span></div>`;

        if (isAudiobookMode && audioContext && audioBuffer && pythonHasTimestamps) {
            let audioIcon = "‚ñ∂Ô∏è"; 
            let audioTitle = "Play Sentence Audio";
            if (currentPlayingSentence === sentenceElement && currentSourceNode) {
                audioIcon = "‚èπÔ∏è"; 
                audioTitle = "Stop Sentence Audio";
            }
            menuHTML += `<div class="contextual-menu-item" data-action="play-pause-audio" title="${audioTitle}"><span class="menu-icon">${audioIcon}</span></div>`;
        }

        contextualMenu.innerHTML = menuHTML;
        contextualMenu.style.display = 'block'; 
        contextualMenu.style.opacity = '0'; 
        contextualMenu.style.transform = 'scale(0.95)'; // Initial state for pop animation

        const rect = sentenceElement.getBoundingClientRect();
        const menuWidth = contextualMenu.offsetWidth;
        const menuHeight = contextualMenu.offsetHeight;
        
        let menuTop = rect.bottom + window.scrollY + 5; 
        let menuLeft;

        // Decide left/right based on clickX relative to viewport center
        const viewportCenterX = window.innerWidth / 2;
        if (clickX < viewportCenterX) { // Click on left half, menu on right of sentence
            menuLeft = rect.left + window.scrollX;
            contextualMenu.style.transformOrigin = 'top left';
        } else { // Click on right half, menu on left of sentence
            menuLeft = rect.right + window.scrollX - menuWidth;
            contextualMenu.style.transformOrigin = 'top right';
        }
        
        // Boundary adjustments
        if (menuLeft < window.scrollX + 10) menuLeft = window.scrollX + 10;
        if (menuLeft + menuWidth > window.innerWidth + window.scrollX - 10) {
            menuLeft = window.innerWidth + window.scrollX - menuWidth - 10;
        }
        if (menuTop + menuHeight > window.innerHeight + window.scrollY - 10) {
            menuTop = rect.top + window.scrollY - menuHeight - 5; 
        }
        if (menuTop < window.scrollY + 10) menuTop = window.scrollY + 10;

        contextualMenu.style.top = menuTop + 'px';
        contextualMenu.style.left = menuLeft + 'px';
        setTimeout(() => { 
             contextualMenu.style.opacity = '1';
             contextualMenu.style.transform = 'scale(1)'; // Pop to full size
        }, 10);
    }

    if (articleContentWrapper) {
        articleContentWrapper.addEventListener('contextmenu', function(event) {
            const targetSentence = event.target.closest('.english-sentence');
            if (targetSentence) {
                event.preventDefault();
                hideContextualMenu(); 
                const translation = targetSentence.dataset.translation;
                if (translation) {
                    displayPopup(targetSentence, translation);
                    currentPopupTargetSentence = targetSentence;
                } else {
                    displayPopup(targetSentence, "No translation available for this sentence.");
                }
                if (!isAudiobookMode) {
                    if (highlightedSentence) highlightedSentence.classList.remove('highlighted-sentence');
                    targetSentence.classList.add('highlighted-sentence');
                    highlightedSentence = targetSentence;
                    lastHighlightedSentenceElement = targetSentence; // Remember for go back
                    updateGoBackButtonVisibility();
                }
            } else {
                hideTranslationPopup();
            }
        });

        articleContentWrapper.addEventListener('click', function(event) {
            const targetSentence = event.target.closest('.english-sentence');

            if (targetSentence) {
                event.stopPropagation(); 
                hideTranslationPopup(); 

                if (highlightedSentence === targetSentence) {
                    if (contextualMenu.style.display === 'block' && contextualMenu.style.opacity === '1') {
                        hideContextualMenu();
                    } else {
                        populateAndShowContextualMenu(targetSentence, event.clientX);
                    }
                } else {
                    if (highlightedSentence) {
                        highlightedSentence.classList.remove('highlighted-sentence');
                    }
                    highlightedSentence = targetSentence;
                    lastHighlightedSentenceElement = targetSentence; // Remember for go back
                    highlightedSentence.classList.add('highlighted-sentence');
                    hideContextualMenu(); 
                    updateGoBackButtonVisibility();


                    if (isAudiobookMode && audioContext && audioBuffer) {
                        playSentenceAudio(targetSentence);
                    } else if (isAudiobookMode && (!audioContext || !audioBuffer)) {
                        console.log("JS: Audiobook mode active, but audio not loaded/ready.");
                    }
                }
            } else {
                if (!contextualMenu.contains(event.target)) { 
                    hideContextualMenu();
                }
                if (!popup.contains(event.target)) { 
                    hideTranslationPopup();
                }
                // Deselect sentence if clicked outside of sentence, menu, or popup
                if (highlightedSentence && 
                    !contextualMenu.contains(event.target) && 
                    !popup.contains(event.target) &&
                    !goBackButton.contains(event.target) ) { // And not go back button
                    highlightedSentence.classList.remove('highlighted-sentence');
                    highlightedSentence = null;
                    // Don't clear lastHighlightedSentenceElement here, so "Go Back" still works
                    updateGoBackButtonVisibility(); 
                }
            }
        });
    }

    if (contextualMenu) {
        contextualMenu.addEventListener('click', function(event) {
            event.stopPropagation(); 
            const actionTarget = event.target.closest('.contextual-menu-item');
            if (!actionTarget || !highlightedSentence) {
                hideContextualMenu();
                return;
            }

            const action = actionTarget.dataset.action;
            switch (action) {
                case 'go-to-top':
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    // After scrolling to top, make sure the "Go Back" button is visible
                    // if lastHighlightedSentenceElement exists.
                    setTimeout(updateGoBackButtonVisibility, 100); // Allow scroll to potentially finish
                    break;
                case 'show-translation':
                    const translation = highlightedSentence.dataset.translation;
                    if (translation) {
                        displayPopup(highlightedSentence, translation);
                        currentPopupTargetSentence = highlightedSentence;
                    } else {
                        displayPopup(highlightedSentence, 'No translation available.');
                    }
                    break;
                case 'play-pause-audio':
                    if (isAudiobookMode && audioContext && audioBuffer && pythonHasTimestamps) {
                        const iconSpan = actionTarget.querySelector('.menu-icon');
                        if (currentPlayingSentence === highlightedSentence && currentSourceNode) {
                            if (currentSourceNode) {
                                try { currentSourceNode.onended = null; currentSourceNode.stop(); currentSourceNode.disconnect(); } catch(e){}
                                currentSourceNode = null;
                            }
                            if (currentPlayingSentence) currentPlayingSentence.classList.remove('playing-sentence');
                            if (iconSpan) iconSpan.textContent = "‚ñ∂Ô∏è";
                            actionTarget.title = "Play Sentence Audio";
                        } else {
                            playSentenceAudio(highlightedSentence);
                            if (iconSpan) iconSpan.textContent = "‚èπÔ∏è";
                            actionTarget.title = "Stop Sentence Audio";
                        }
                    }
                    break;
            }
            hideContextualMenu();
        });
    }

    if (popup) { 
        popup.addEventListener('click', function() {
            hideTranslationPopup();
        });
    }

    document.addEventListener('click', function(event) {
        if (contextualMenu.style.display === 'block' &&
            !contextualMenu.contains(event.target) &&
            !event.target.closest('.english-sentence')) {
            hideContextualMenu();
        }

        if (popup.style.display === 'block' &&
            !popup.contains(event.target) &&
            !event.target.closest('.english-sentence') && 
            !(contextualMenu.style.display === 'block' && contextualMenu.contains(event.target))) { 
            hideTranslationPopup();
        }
        updateGoBackButtonVisibility(); // Check on any click
    });
    
    // --- Audiobook Mode Logic (largely unchanged, ensure it calls updateGoBackButtonVisibility if needed) ---
    if (toggleAudiobookModeButton) {
        // ... initAudioContext, maxSentenceEndTime calculation ... (as before)
        function initAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    alert("Web Audio API is not supported by this browser."); return false;
                }
            }
            if (audioContext.state === 'suspended') audioContext.resume();
            return true;
        }
        
        document.querySelectorAll('.english-sentence').forEach(s => {
            const endTime = parseInt(s.dataset.endTimeMs, 10);
            if (!isNaN(endTime) && endTime > maxSentenceEndTime) maxSentenceEndTime = endTime;
        });

        toggleAudiobookModeButton.addEventListener('click', function() {
            if (!initAudioContext() && !isAudiobookMode) return;
            isAudiobookMode = !isAudiobookMode;
            if (isAudiobookMode) {
                toggleAudiobookModeButton.textContent = 'Disable Audiobook Mode';
                localAudioFileInput.style.display = 'inline-block';
                audiobookHint.style.display = 'block';
                if (highlightedSentence) {
                    highlightedSentence.classList.remove('highlighted-sentence');
                    highlightedSentence = null; // Don't affect lastHighlightedSentenceElement
                }
            } else { 
                toggleAudiobookModeButton.textContent = 'Enable Audiobook Mode';
                localAudioFileInput.style.display = 'none';
                audiobookHint.style.display = 'none';
                if (currentSourceNode) { try { currentSourceNode.stop(); } catch(e){} currentSourceNode = null; }
                if (currentPlayingSentence) currentPlayingSentence.classList.remove('playing-sentence');
                currentPlayingSentence = null;
            }
            hideContextualMenu(); 
            hideTranslationPopup();
            updateGoBackButtonVisibility();
        });

        // ... localAudioFileInput change listener ... (as before)
        localAudioFileInput.addEventListener('change', async function(event) {
            if (!audioContext && !initAudioContext()) return;
            const file = event.target.files[0];
            if (file) {
                audioFileNameSpan.textContent = "Loading: " + file.name;
                if (currentSourceNode) { try { currentSourceNode.stop(); } catch(e){} currentSourceNode = null; }
                if (currentPlayingSentence) currentPlayingSentence.classList.remove('playing-sentence');
                currentPlayingSentence = null;
                audioBuffer = null; 
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    audioFileNameSpan.textContent = file.name;
                     if (maxSentenceEndTime > 0 && (audioBuffer.duration * 1000 < maxSentenceEndTime)) {
                        alert(`Warning: Audio duration shorter than max sentence time.`);
                    }
                } catch (e) {
                    alert(`Error decoding audio: ${e.message}`);
                    audioFileNameSpan.textContent = "Error loading: " + file.name;
                    audioBuffer = null;
                }
            }
        });

        // ... playSentenceAudio, proceedWithPlayback ... (as before, but update menu if audio ends)
        function playSentenceAudio(sentenceElement) {
            if (!audioContext || audioContext.state === 'closed') { alert("Audio system error."); return; }
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => proceedWithPlayback(sentenceElement))
                                  .catch(e => { alert("Could not start audio."); });
            } else {
                proceedWithPlayback(sentenceElement);
            }
        }
        
        function proceedWithPlayback(sentenceElement) {
            if (!audioBuffer) { alert("Please load an audio file."); return; }
            if (currentSourceNode) { try { currentSourceNode.onended = null; currentSourceNode.stop(); } catch (e) {} }
            if (currentPlayingSentence && currentPlayingSentence !== sentenceElement) {
                currentPlayingSentence.classList.remove('playing-sentence');
            }

            const startTimeMs = parseInt(sentenceElement.dataset.startTimeMs, 10);
            const endTimeMs = parseInt(sentenceElement.dataset.endTimeMs, 10);
            if (isNaN(startTimeMs) || isNaN(endTimeMs)) { alert("Sentence missing time data."); return; }

            const offsetInSeconds = startTimeMs / 1000.0;
            let durationInSeconds = (endTimeMs - startTimeMs) / 1000.0;
            if (offsetInSeconds < 0 || offsetInSeconds >= audioBuffer.duration) { alert("Sentence start time out of audio bounds."); return; }
            if (durationInSeconds <= 0) durationInSeconds = 0.05; 
            const clampedDuration = Math.min(durationInSeconds, audioBuffer.duration - offsetInSeconds);

            currentPlayingSentence = sentenceElement;
            currentPlayingSentence.classList.add('playing-sentence');
            currentSourceNode = audioContext.createBufferSource();
            currentSourceNode.buffer = audioBuffer;
            currentSourceNode.connect(audioContext.destination);
            
            try {
                currentSourceNode.start(0, offsetInSeconds, clampedDuration); 
            } catch (e) {
                alert(`Could not start playback: ${e.message}`);
                if (currentPlayingSentence) currentPlayingSentence.classList.remove('playing-sentence');
                currentPlayingSentence = null; return;
            }
            
            currentSourceNode.onended = () => {
                if (contextualMenu.style.display === 'block' && highlightedSentence === sentenceElement) {
                    const audioButtonIcon = contextualMenu.querySelector('.contextual-menu-item[data-action="play-pause-audio"] .menu-icon');
                    if (audioButtonIcon) audioButtonIcon.textContent = "‚ñ∂Ô∏è";
                    const audioButton = contextualMenu.querySelector('.contextual-menu-item[data-action="play-pause-audio"]');
                    if(audioButton) audioButton.title = "Play Sentence Audio";
                }
                // Don't remove 'playing-sentence' class here if we want highlight to persist after audio ends
                // Only remove it if another sentence is played or mode changes.
            }; 
        } 
    } else {
        console.log("JS: toggleAudiobookModeButton not found.");
    }
});
</script>
{% endblock %}